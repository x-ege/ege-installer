name: Build and Package

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-tags: true

      - name: Setup development environment
        run: |
          # 使用 setup.ps1 自动准备开发环境
          .\scripts\setup.ps1 -Auto -SkipNsisCheck -XegeLibsPath "${{ github.workspace }}\xege_libs"

      - name: Install NSIS
        run: choco install nsis -y

      - name: Get version
        id: version
        run: |
          $version = Get-Date -Format "yyyy.MM.dd"
          
          # Try to get version from git tag
          $tag = git describe --tags --abbrev=0 2>$null
          if ($LASTEXITCODE -eq 0 -and $tag) {
            $version = $tag -replace "^v", ""
          }
          
          # For PR builds, add PR number
          if ("${{ github.event_name }}" -eq "pull_request") {
            $version = "$version-pr${{ github.event.pull_request.number }}"
          }
          
          Write-Host "Version: $version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Build installer package
        run: |
          .\scripts\build.ps1 `
            -XegeLibsPath "${{ github.workspace }}\xege_libs" `
            -Version "${{ steps.version.outputs.VERSION }}" `
            -OutputDir "dist"

      - name: Verify build output
        run: |
          $files = Get-ChildItem -Path "dist" -File -ErrorAction SilentlyContinue
          if (-not $files) {
            Write-Host "Error: No output files found" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "Build outputs:" -ForegroundColor Cyan
          foreach ($file in $files) {
            $sizeMB = [math]::Round($file.Length / 1MB, 2)
            Write-Host "  $($file.Name) - $sizeMB MB"
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ege-setup-${{ steps.version.outputs.VERSION }}
          path: dist/*
          retention-days: 30
