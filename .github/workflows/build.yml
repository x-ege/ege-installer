name: Build and Package

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup development environment
        run: |
          # 使用 setup.ps1 自动准备开发环境
          .\scripts\setup.ps1 -Auto -SkipNsisCheck -XegeLibsPath "${{ github.workspace }}\xege_libs"

      - name: Install NSIS
        run: choco install nsis -y

      - name: Get version
        id: version
        run: |
          # Read version from xege_libs/version.txt (EGE library version)
          $versionFile = "${{ github.workspace }}\xege_libs\version.txt"
          $version = "1.0.0"
          
          if (Test-Path $versionFile) {
            try {
              $version = (Get-Content $versionFile -Raw).Trim()
              Write-Host "Using EGE library version from version.txt: $version"
            } catch {
              Write-Host "Error reading version.txt, using default: $version"
            }
          } else {
            Write-Host "version.txt not found, using default: $version"
          }
          
          # Create product version for NSIS VIProductVersion (X.X.X.X format, digits only, no leading zeros)
          $productVersion = $version -replace "[^0-9.]", "" -replace "\.+", "."
          # Remove leading zeros from each segment
          $productVersion = ($productVersion.Split('.') | ForEach-Object { [int]$_ }) -join '.'
          if ($productVersion -notmatch "^\d+\.\d+\.\d+") {
            $productVersion = "1.0.0"
          }
          # Ensure exactly 4 parts for NSIS (append .0 if needed)
          $parts = $productVersion.Split('.')
          if ($parts.Length -eq 3) {
            $productVersion = "$productVersion.0"
          } elseif ($parts.Length -lt 3) {
            $productVersion = "1.0.0.0"
          }
          
          # For PR builds, add PR suffix to display version
          if ("${{ github.event_name }}" -eq "pull_request") {
            $version = "$version-pr${{ github.event.pull_request.number }}"
          }
          
          Write-Host "Display Version: $version"
          Write-Host "Product Version: $productVersion"
          "VERSION=$version" >> $env:GITHUB_OUTPUT
          "PRODUCT_VERSION=$productVersion" >> $env:GITHUB_OUTPUT
          
          # Ensure exit code is 0
          exit 0

      - name: Build installer package
        run: |
          .\scripts\build.ps1 `
            -XegeLibsPath "${{ github.workspace }}\xege_libs" `
            -Version "${{ steps.version.outputs.VERSION }}" `
            -ProductVersion "${{ steps.version.outputs.PRODUCT_VERSION }}" `
            -OutputDir "dist"

      - name: Verify build output
        run: |
          $files = Get-ChildItem -Path "dist" -File -ErrorAction SilentlyContinue
          if (-not $files) {
            Write-Host "Error: No output files found" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "Build outputs:" -ForegroundColor Cyan
          foreach ($file in $files) {
            $sizeMB = [math]::Round($file.Length / 1MB, 2)
            Write-Host "  $($file.Name) - $sizeMB MB"
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ege-installer-${{ steps.version.outputs.VERSION }}
          path: dist/*
          retention-days: 30
